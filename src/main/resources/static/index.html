<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spring Boot WebSocket Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        #messageArea li { animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .typing-indicator { min-height: 24px; }
        .message-container { display: flex; max-width: 75%; word-wrap: break-word; }
        .message-wrapper { display: flex; }
        .sent { justify-content: flex-end; margin-left: auto; }
        .received { justify-content: flex-start; margin-right: auto; }
        .message-content { padding: 8px 12px; border-radius: 12px; }
        .sent .message-content { background-color: #dcfce7; }
        .received .message-content { background-color: #f3f4f6; }
        .private .received .message-content { background-color: #e0f2fe; }
        .user-item, .channel-item { cursor: pointer; transition: background-color 0.2s; }
        .user-item:hover, .channel-item:hover { background-color: #e5e7eb; }
        .active-conversation { background-color: #dbeafe; font-weight: 600; }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 flex items-center justify-center h-screen">

    <div id="auth-page" class="w-full max-w-md">
        <div id="login-view" class="p-8 bg-white rounded-2xl shadow-lg text-center">
            <h1 class="text-2xl font-bold mb-6 text-slate-900">Login to Chat</h1>
            <form id="loginForm" action="/login" method="post" class="space-y-4">
                <input type="text" name="username" placeholder="Username" autocomplete="username" class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none transition" required>
                <input type="password" name="password" placeholder="Password" autocomplete="current-password" class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none transition" required>
                <div id="login-error" class="text-red-500 text-sm hidden">Invalid username or password.</div>
                <button type="submit" class="w-full bg-blue-500 text-white font-bold py-3 rounded-lg hover:bg-blue-600 transition-colors">Login</button>
            </form>
            <p class="mt-6 text-sm">Don't have an account? <a href="#" id="show-register" class="font-semibold text-blue-500 hover:underline">Register here</a></p>
        </div>
        <div id="register-view" class="hidden p-8 bg-white rounded-2xl shadow-lg text-center">
            <h1 class="text-2xl font-bold mb-6 text-slate-900">Create an Account</h1>
            <form id="registerForm" class="space-y-4">
                <input type="text" id="register-username" placeholder="Choose a username" class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none transition" required>
                <input type="password" id="register-password" placeholder="Choose a password" class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none transition" required>
                <div id="register-message" class="text-sm"></div>
                <button type="submit" class="w-full bg-green-500 text-white font-bold py-3 rounded-lg hover:bg-green-600 transition-colors">Register</button>
            </form>
            <p class="mt-6 text-sm">Already have an account? <a href="#" id="show-login" class="font-semibold text-blue-500 hover:underline">Login here</a></p>
        </div>
    </div>

    <div id="chat-page" class="hidden w-full"></div>

    <script>
        // --- Global State ---
        let stompClient = null;
        let username = null;
        let channel = null;
        let allMessages = []; 
        let activeConversation = null; 
        let onlineUsers = []; 
        let unreadCounts = new Map();
        let typingUsers = {};
        const TYPING_TIMEOUT = 1500;
        const colors = ['#2196F3', '#32c787', '#f44336', '#FFC107', '#FF5722', '#607D8B', '#9C27B0', '#009688'];

        // --- Main App Logic ---
        async function startApp() {
            if (window.location.pathname.includes('/chat')) {
                try {
                    const response = await fetch('/api/user/me');
                    if (response.ok) {
                        username = await response.text();
                        if (username) {
                            document.querySelector('#auth-page').style.display = 'none';
                            document.querySelector('#chat-page').classList.remove('hidden');
                            initializeChatUI();
                        }
                    } else { window.location.href = "/"; }
                } catch (e) { window.location.href = "/"; }
            } else {
                setupAuthPage();
            }
        }

        function setupAuthPage() {
            document.querySelector('#auth-page').style.display = 'block';
            const showRegisterLink = document.querySelector('#show-register');
            const showLoginLink = document.querySelector('#show-login');
            const registerForm = document.querySelector('#registerForm');
            const loginError = document.querySelector('#login-error');
            const registerMessage = document.querySelector('#register-message');
            showRegisterLink.addEventListener('click', (e) => { e.preventDefault(); document.querySelector('#login-view').classList.add('hidden'); document.querySelector('#register-view').classList.remove('hidden'); });
            showLoginLink.addEventListener('click', (e) => { e.preventDefault(); document.querySelector('#register-view').classList.add('hidden'); document.querySelector('#login-view').classList.remove('hidden'); });
            registerForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const regUsername = document.querySelector('#register-username').value.trim();
                const regPassword = document.querySelector('#register-password').value.trim();
                if (!regUsername || !regPassword) return;
                try {
                    const response = await fetch('/api/register', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username: regUsername, password: regPassword }) });
                    const message = await response.text();
                    registerMessage.textContent = message;
                    registerMessage.className = response.ok ? 'text-sm text-green-500' : 'text-sm text-red-500';
                } catch (error) {
                    registerMessage.textContent = 'An error occurred during registration.';
                    registerMessage.className = 'text-sm text-red-500';
                }
            });
            if (new URLSearchParams(window.location.search).has('error')) {
                loginError.classList.remove('hidden');
            }
        }

        function initializeChatUI() {
            const chatPage = document.querySelector('#chat-page');
            chatPage.innerHTML = `
                <div class="w-full max-w-5xl h-[90vh] flex bg-white rounded-2xl shadow-lg">
                    <aside class="w-1/4 bg-slate-50 border-r border-slate-200 p-4 flex flex-col rounded-l-2xl">
                        <div class="mb-4">
                            <h3 class="text-lg font-bold text-slate-900">Welcome, ${username}!</h3>
                            <form action="/logout" method="post"><button type="submit" class="text-sm text-red-500 hover:underline">Logout</button></form>
                        </div>
                        <div id="channel-form-container">
                             <form id="channelForm" class="space-y-2 mb-4">
                                <input type="text" id="channel-input" placeholder="Enter a room name" class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm" required>
                                <button type="submit" class="w-full bg-blue-500 text-white font-bold py-2 rounded-lg text-sm hover:bg-blue-600">Join Channel</button>
                            </form>
                        </div>
                        <div id="conversation-list" class="hidden">
                            <h3 class="text-lg font-bold text-slate-900 mb-2">Conversations</h3>
                            <div id="channel-item-container"></div>
                            <h3 class="text-lg font-bold text-slate-900 mt-4 mb-2">Who's Online</h3>
                            <ul id="userList" class="space-y-2 overflow-y-auto flex-1"></ul>
                        </div>
                    </aside>
                    <main id="chat-main" class="w-3/4 flex-col hidden">
                        <header class="p-4 border-b border-slate-200"><h2 id="chat-header" class="text-xl font-bold text-slate-900"></h2></header>
                        <ul id="messageArea" class="flex-1 p-6 space-y-2 overflow-y-auto"></ul>
                        <div id="typing-indicator" class="typing-indicator px-6 pb-2 text-sm text-slate-500 italic"></div>
                        <footer class="p-4 bg-slate-50 border-t border-slate-200 rounded-br-2xl">
                            <form id="messageForm" class="flex gap-3">
                                <input type="text" id="message" placeholder="Type a message..." autocomplete="off" class="flex-1 px-4 py-3 border border-slate-300 rounded-lg">
                                <button type="submit" class="bg-blue-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-600">Send</button>
                            </form>
                        </footer>
                    </main>
                </div>`;
            
            document.querySelector('#channelForm').addEventListener('submit', connectToChannel);
        }
        
        function connectToChannel(event) {
            event.preventDefault();
            channel = document.querySelector('#channel-input').value.trim().toLowerCase();
            if(channel) {
                document.querySelector('#channel-form-container').classList.add('hidden');
                document.querySelector('#conversation-list').classList.remove('hidden');
                document.querySelector('#chat-main').classList.add('flex'); // Show the main chat area
                document.querySelector('#chat-main').classList.remove('hidden');
                activeConversation = channel;
                const socket = new SockJS('/ws');
                stompClient = Stomp.over(socket);
                stompClient.connect({}, onChatConnected, onError);
            }
        }

        async function onChatConnected() {
            stompClient.subscribe(`/topic/public/${channel}`, onMessageReceived);
            stompClient.subscribe(`/topic/users/${channel}`, onUserListReceived);
            stompClient.subscribe(`/user/${username}/queue/private`, onMessageReceived);
            try {
                const history = await fetch(`/messages?channel=${channel}`).then(response => response.json());
                allMessages = history;
                renderChatView();
            } catch (error) { console.error('Could not fetch chat history:', error); }
            stompClient.send(`/app/chat.addUser/${channel}`, {}, JSON.stringify({sender: username, type: 'JOIN'}));
            document.querySelector('#messageForm').addEventListener('submit', sendMessage);
            document.querySelector('#message').addEventListener('input', sendTyping);
        }

        function onMessageReceived(payload) {
            const message = JSON.parse(payload.body);
            if (message.type === 'TYPING') { handleTypingIndicator(message); return; }
            allMessages.push(message);
            if (message.type === 'PRIVATE_MESSAGE' && message.sender !== username && activeConversation !== message.sender) {
                const currentCount = unreadCounts.get(message.sender) || 0;
                unreadCounts.set(message.sender, currentCount + 1);
                updateSidebarUI();
            }
            if (typingUsers[message.sender]) { clearTimeout(typingUsers[message.sender]); delete typingUsers[message.sender]; updateTypingIndicator(); }
            renderChatView();
        }

        function onUserListReceived(payload) { onlineUsers = JSON.parse(payload.body); updateSidebarUI(); }
        function sendMessage(event) {
            event.preventDefault();
            const messageInput = document.querySelector('#message');
            const messageContent = messageInput.value.trim();
            if(!messageContent || !stompClient) return;
            let chatMessage;
            let destination;
            if (activeConversation === channel) {
                destination = `/app/chat.sendMessage/${channel}`;
                chatMessage = { sender: username, content: messageContent, type: 'CHAT' };
            } else {
                destination = "/app/chat.sendPrivateMessage";
                chatMessage = { sender: username, recipient: activeConversation, content: messageContent, channel: channel, type: 'PRIVATE_MESSAGE' };
            }
            stompClient.send(destination, {}, JSON.stringify(chatMessage));
            if(chatMessage.type === 'PRIVATE_MESSAGE') { allMessages.push(chatMessage); renderChatView(); }
            messageInput.value = '';
        }

        function updateSidebarUI() {
            const channelItemContainer = document.querySelector('#channel-item-container');
            const userList = document.querySelector('#userList');
            channelItemContainer.innerHTML = '';
            const channelElement = document.createElement('div');
            channelElement.classList.add('p-2', 'rounded-lg', 'channel-item', 'flex', 'items-center');
            channelElement.innerHTML = `<span># ${channel}</span>`;
            channelElement.onclick = () => switchConversation(channel);
            channelItemContainer.appendChild(channelElement);
            userList.innerHTML = '';
            onlineUsers.forEach(user => {
                const userElement = document.createElement('li');
                userElement.classList.add('flex', 'items-center', 'gap-3', 'p-2', 'rounded-lg');
                if (user !== username) { userElement.classList.add('user-item'); userElement.onclick = () => switchConversation(user); } 
                else { userElement.style.cursor = "default"; userElement.title = "This is you!"; }
                const avatarElement = document.createElement('div');
                avatarElement.classList.add('w-8', 'h-8', 'rounded-full', 'flex', 'items-center', 'justify-center', 'text-white', 'font-bold', 'text-sm', 'flex-shrink-0');
                avatarElement.textContent = user[0];
                avatarElement.style.backgroundColor = getAvatarColor(user);
                const usernameText = document.createElement('span');
                usernameText.textContent = user;
                const notificationBadge = document.createElement('span');
                notificationBadge.classList.add('w-5', 'h-5', 'bg-red-500', 'text-white', 'text-xs', 'font-bold', 'rounded-full', 'ml-auto', 'flex', 'items-center', 'justify-center', 'opacity-0', 'transition-opacity');
                const unreadCount = unreadCounts.get(user);
                if (unreadCount > 0) { notificationBadge.textContent = unreadCount; notificationBadge.classList.remove('opacity-0'); }
                userElement.appendChild(avatarElement);
                userElement.appendChild(usernameText);
                userElement.appendChild(notificationBadge);
                userList.appendChild(userElement);
            });
            updateConversationHighlights();
        }
        
        function switchConversation(target) {
            activeConversation = target;
            if (unreadCounts.has(target)) { unreadCounts.delete(target); updateSidebarUI(); }
            renderChatView();
        }

        function renderChatView() {
            const messageArea = document.querySelector('#messageArea');
            const chatHeader = document.querySelector('#chat-header');
            messageArea.innerHTML = '';
            let messagesToRender = [];
            if (activeConversation === channel) {
                chatHeader.textContent = `Welcome to #${channel}`;
                messagesToRender = allMessages.filter(msg => msg.type !== 'PRIVATE_MESSAGE');
            } else {
                chatHeader.textContent = `Chat with ${activeConversation}`;
                messagesToRender = allMessages.filter(msg => msg.type === 'PRIVATE_MESSAGE' && ((msg.sender === username && msg.recipient === activeConversation) || (msg.sender === activeConversation && msg.recipient === username)));
            }
            messagesToRender.forEach(displayMessage);
            updateConversationHighlights();
        }

        function updateConversationHighlights() {
            document.querySelectorAll('.channel-item, .user-item').forEach(el => el.classList.remove('active-conversation'));
            const currentConversationText = activeConversation === channel ? `# ${channel}` : activeConversation;
            const elementToHighlight = Array.from(document.querySelectorAll('.channel-item, .user-item')).find(el => el.textContent.startsWith(currentConversationText));
            elementToHighlight?.classList.add('active-conversation');
        }
        
        function displayMessage(message) {
            const messageArea = document.querySelector('#messageArea');
            const messageWrapper = document.createElement('li');
            messageWrapper.classList.add('message-wrapper');
            const messageContainer = document.createElement('div');
            messageContainer.classList.add('message-container', 'gap-3');
            const contentElement = document.createElement('div');
            contentElement.classList.add('message-content');
            if (message.type === 'JOIN' || message.type === 'LEAVE') {
                messageWrapper.classList.add('justify-center');
                contentElement.classList.add('text-center', 'text-slate-500', 'text-sm', 'italic', 'bg-transparent', 'p-0');
                contentElement.textContent = message.type === 'JOIN' ? `${message.sender} joined!` : `${message.sender} left!`;
                messageWrapper.appendChild(contentElement);
            } else {
                const isSent = message.sender === username;
                messageWrapper.classList.add(isSent ? 'sent' : 'received');
                if (message.type === 'PRIVATE_MESSAGE') {
                    messageContainer.classList.add('private');
                    const from = isSent ? 'You' : message.sender;
                    const to = message.recipient === username ? 'you' : message.recipient;
                    contentElement.innerHTML = `<p class="font-bold">${from} to ${to}:</p><p>${message.content}</p>`;
                } else {
                    const usernameElement = document.createElement('p');
                    usernameElement.classList.add('font-bold');
                    usernameElement.textContent = message.sender;
                    usernameElement.style.color = getAvatarColor(message.sender);
                    const textElement = document.createElement('p');
                    textElement.classList.add('text-slate-700');
                    textElement.textContent = message.content;
                    contentElement.appendChild(usernameElement);
                    contentElement.appendChild(textElement);
                }
                if (!isSent) {
                    const avatarElement = document.createElement('div');
                    avatarElement.classList.add('w-10', 'h-10', 'rounded-full', 'flex', 'items-center', 'justify-center', 'text-white', 'font-bold', 'flex-shrink-0');
                    avatarElement.textContent = message.sender[0];
                    avatarElement.style.backgroundColor = getAvatarColor(message.sender);
                    messageContainer.appendChild(avatarElement);
                }
                messageContainer.appendChild(contentElement);
                messageWrapper.appendChild(messageContainer);
            }
            messageArea.appendChild(messageWrapper);
            messageArea.scrollTop = messageArea.scrollHeight;
        }

        function getAvatarColor(messageSender) { let hash = 0; for (let i = 0; i < messageSender.length; i++) hash += messageSender.charCodeAt(i); return colors[Math.abs(hash % colors.length)]; }
        function sendTyping() { if(stompClient && activeConversation === channel) { stompClient.send(`/app/chat.typing/${channel}`, {}, JSON.stringify({ sender: username, type: 'TYPING' })); } }
        function handleTypingIndicator(message) {
            const typingUsername = message.sender;
            if (typingUsername === username || activeConversation !== channel) return;
            if (typingUsers[typingUsername]) clearTimeout(typingUsers[typingUsername]);
            typingUsers[typingUsername] = setTimeout(() => { delete typingUsers[typingUsername]; updateTypingIndicator(); }, TYPING_TIMEOUT);
            updateTypingIndicator();
        }
        function updateTypingIndicator() {
            const users = Object.keys(typingUsers);
            let text = '';
            if (users.length === 1) text = `${users[0]} is typing...`;
            else if (users.length > 1) text = 'Several people are typing...';
            document.querySelector('#typing-indicator').textContent = text;
        }
        function onError() { console.error('Could not connect to WebSocket server.'); }

        // Run the app!
        startApp();
    </script>
</body>
</html>